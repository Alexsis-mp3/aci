FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency files
COPY pyproject.toml ./

# Install dependencies directly using pip
RUN pip install --no-cache-dir \
    fastapi[standard]>=0.115.12 \
    uvicorn[standard]>=0.31.1 \
    pydantic>=2.11.3 \
    sqlalchemy>=2.0.40 \
    pgvector>=0.4.1 \
    authlib>=1.5.2 \
    psycopg[binary]>=3.2.9 \
    httpx>=0.27.2 \
    itsdangerous>=2.2.0 \
    openai>=1.80.0 \
    click>=8.1.8 \
    openapi-spec-validator>=0.7.1 \
    jsonschema>=4.23.0 \
    limits>=5.2.0 \
    jinja2>=3.1.6 \
    deepdiff>=8.5.0 \
    python-json-logger>=3.3.0 \
    logfire[fastapi,sqlalchemy]>=3.16.0 \
    sentry-sdk[fastapi]>=2.26.1 \
    google-api-python-client>=2.167.0 \
    aws-encryption-sdk[mpl]>=4.0.1 \
    boto3>=1.37.36 \
    rich>=13.9.4 \
    propelauth-fastapi>=4.2.6 \
    svix>=1.65.0 \
    stripe>=12.1.0 \
    e2b-code-interpreter>=1.5.0 \
    browser-use>=0.5.0 \
    langchain-openai>=0.3.28 \
    elevenlabs>=2.8.1

# Copy application code
COPY . .

# Make scripts executable
RUN chmod +x scripts/*.sh start.sh

# Expose port
EXPOSE 8000

# Set environment variables
ENV PYTHONPATH=/app

# Health check - simpler version that just checks if the process is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD ps aux | grep uvicorn || exit 1

# Run the application using the startup script
CMD ["./start.sh"]
